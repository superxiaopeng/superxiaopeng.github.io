<!DOCTYPE html><html><head><title>使用JavaScript实现Ajax类</title><meta charset='utf-8'><link href='https://cdn.maxiang.io/res-min/themes/marxico.css' rel='stylesheet'><style></style></head><body><div id='preview-contents' class='note-content'>
                        
                    



<h1 id="使用javascript实现ajax类">使用JavaScript实现Ajax类</h1>

<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
</div></code></pre>

<p>使用new关键字调用函数，会做下面五件事情： <br>
1、创建一个空对象({}，就是我们所说的实例对象) <br>
2、 <br>
3、把该实例对象绑定到this上 <br>
4、在函数内部，通过在this上添加属性和方法，来写入实例对象内部() <br>
5、函数默认返回该实例对象 <br>
然后把实例对象保存在xhr变量里，在函数外部可以通过xhr变量来为实例对象写入属性和方法(别忘了在函数内部可以使用this做这件事)，就像下面这样： <br>
<code>xhr.name = 'xiaopeng'; //本行代码只做示例用，不会包裹在主代码里</code> <br>
上面的代码向我们演示了如何在实例对象内部添加一个键为name，值为’xiaopeng’的属性。</p>



<h3 id="实现http-post请求">实现HTTP POST请求</h3>

<p>我们使用XMLHttpRequest对象提供的open、setRequestHeader及send方法来实现一个post方法，就像下面这样：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    <span class="hljs-comment">//post()发送HTTP POST请求</span>
</div><div class="hljs-line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        xhr.open(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/hello'</span>, <span class="hljs-literal">true</span>);
</div><div class="hljs-line">        xhr.setRequestHeader({<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>});
</div><div class="hljs-line">        xhr.send(<span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">name</span>: <span class="hljs-string">'xiaopeng'</span>}));
</div><div class="hljs-line">    }
</div></code></pre>

<p>上面通过xhr来访问方法(别忘了xhr变量里还保存着XMLHttpRequest对象的实例对象，在创建实例对象的过程中，open、setrequestHeader及send方法会被拷贝一份，然后放入实例对象里)</p>



<h3 id="处理浏览器接收到数据">处理浏览器接收到数据</h3>

<p>实现一个receiveData()来做这项工作：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    <span class="hljs-comment">//接收服务器传来的数据</span>
</div><div class="hljs-line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">receiveData</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        <span class="hljs-comment">//onreadystatechange属性监听readyState值的变化</span>
</div><div class="hljs-line">        xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(xhr.readyState === <span class="hljs-number">4</span>) {
</div><div class="hljs-line">                <span class="hljs-keyword">if</span>(xhr.status === <span class="hljs-number">200</span>) {
</div><div class="hljs-line">                    <span class="hljs-comment">/*</span>
</div><div class="hljs-line"><span class="hljs-comment">                    只有readyState值为4且status值为200时，</span>
</div><div class="hljs-line"><span class="hljs-comment">                    才表明浏览器已经接收到服务器发来的全部数据。</span>
</div><div class="hljs-line"><span class="hljs-comment">                    response属性的值就是接收到的数据</span>
</div><div class="hljs-line"><span class="hljs-comment">                    */</span>
</div><div class="hljs-line">                    <span class="hljs-built_in">console</span>.log(xhr.response);
</div><div class="hljs-line">                } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'出错了'</span>)；
</div><div class="hljs-line">                }
</div><div class="hljs-line">            } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">                <span class="hljs-built_in">console</span>.log(readyState);
</div><div class="hljs-line">            }
</div><div class="hljs-line">        }
</div><div class="hljs-line">    }
</div></code></pre>

<p><code>readyState</code>属性有五个值</p>

<table><tbody><tr style="font-weight:bold">  <td>值</td>  <td>描述</td></tr><tr>  <td>0</td>  <td>XMLHttpRequest对象已被实例化</td></tr><tr>  <td>1</td>  <td>已调用open，未调用send(HTTP请求还没有发送给服务器)</td></tr><tr>  <td>2</td>  <td>已调用send(HTTP请求已被发送给服务器，但未接收到响应数据)</td></tr><tr>  <td>3</td>  <td>所有响应头部都已被接收到，响应体开始被接收但未完成</td></tr><tr>  <td>4</td>  <td>所有HTTP响应数据都已被接收到</td></tr></tbody></table>

<p><code>onreadystatechange</code>属性指定的函数会在readyState发生改变时被调用，通常<code>onreadystatechange</code>要设置在<code>open</code>方法之前，<code>XMLHttpRequest</code>对象被实例化(<code>new XMLHttpRequest()</code>)之后，就像下面这样：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
</div><div class="hljs-line">    xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        <span class="hljs-keyword">if</span>(xhr.readyState === <span class="hljs-number">4</span>) {
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(xhr.status === <span class="hljs-number">200</span>) {
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">                <span class="hljs-built_in">console</span>.log(xhr.response);
</div><div class="hljs-line">            } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'出错了'</span>)；
</div><div class="hljs-line">            }
</div><div class="hljs-line">        } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">            <span class="hljs-built_in">console</span>.log(readyState);
</div><div class="hljs-line">        }
</div><div class="hljs-line">    }
</div><div class="hljs-line">    xhr.open();
</div><div class="hljs-line">    <span class="hljs-comment">//...</span>
</div></code></pre>

<p><code>onreadystatechange</code>属性指定的函数会被调用四次，在<code>new XMLHttpRequest()</code>之后，<code>readyState</code>值为0(回顾一下上面的表格)，在完成一次完整的请求与响应的过程之后，<code>readyState</code>值为4， <code>readyState</code>改变了四次，所以函数也被调用了四次。</p>

<p>我们来回顾一下到目前为止的所有代码：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
</div><div class="hljs-line">    <span class="hljs-comment">//post()实现HTTP POST请求</span>
</div><div class="hljs-line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        <span class="hljs-comment">//onreadystatechange通常设置在open之前</span>
</div><div class="hljs-line">        receiveData();
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        xhr.open(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/hello'</span>, <span class="hljs-literal">true</span>);
</div><div class="hljs-line">        xhr.setRequestHeader({<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>});
</div><div class="hljs-line">        xhr.send(<span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">name</span>: <span class="hljs-string">'xiaopeng'</span>}));
</div><div class="hljs-line">    }
</div><div class="hljs-line">    <span class="hljs-comment">//接收服务器传来的数据</span>
</div><div class="hljs-line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">receiveData</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        <span class="hljs-comment">//onreadystatechange属性监听readyState值的变化</span>
</div><div class="hljs-line">        xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(xhr.readyState === <span class="hljs-number">4</span>) {
</div><div class="hljs-line">                <span class="hljs-keyword">if</span>(xhr.status === <span class="hljs-number">200</span>) {
</div><div class="hljs-line">                    <span class="hljs-comment">/*</span>
</div><div class="hljs-line"><span class="hljs-comment">                    只有readyState值为4且status值为200时，</span>
</div><div class="hljs-line"><span class="hljs-comment">                    才表明浏览器已经接收到服务器发来的全部数据。</span>
</div><div class="hljs-line"><span class="hljs-comment">                    response属性的值就是接收到的数据</span>
</div><div class="hljs-line"><span class="hljs-comment">                    */</span>
</div><div class="hljs-line">                    <span class="hljs-built_in">console</span>.log(xhr.response);
</div><div class="hljs-line">                } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'出错了'</span>);
</div><div class="hljs-line">                }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">            } <span class="hljs-keyword">else</span> {
</div><div class="hljs-line">                <span class="hljs-built_in">console</span>.log(xhr.readyState);
</div><div class="hljs-line">            }
</div><div class="hljs-line">        }
</div><div class="hljs-line">    }
</div></code></pre>

<p>你应该这样向服务器发送<code>HTTP POST</code>请求：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    post();
</div></code></pre>



<h3 id="实现http-get请求">实现HTTP GET请求</h3>

<p>类似于<code>post</code>方法的实现，定义一个<code>get</code>方法：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line">    <span class="hljs-comment">//get()发送HTTP GET请求</span>
</div><div class="hljs-line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"></span>) </span>{
</div><div class="hljs-line">        <span class="hljs-comment">//onreadystatechange通常设置在open之前</span>
</div><div class="hljs-line">        receiveData();
</div><div class="hljs-line">        xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/hello'</span>, <span class="hljs-literal">true</span>);
</div><div class="hljs-line">        xhr.send();
</div><div class="hljs-line">    }
</div></code></pre>

<p><code>GET</code>请求不需要向服务器提交数据，可以不需要<code>setRequestHeader</code>来指定提交的数据类型。</p>



<h3 id="实现ajax类">实现Ajax类</h3>

<p>接下来我们使用ES6的class关键字把上述所有代码封装进一个名为<code>Ajax</code>的类里面，就像下面这样：</p>



<pre class="prettyprint hljs-dark"><code class="language-javascript hljs"><div class="hljs-line"><wbr>
</div></code></pre></div></body></html>